# Unpacking
Using `file` command, I knew it's UPXed windows executable, so I decompressed it with UPX
# Static Analysis 

#### Basic Information
```
MD5          a8ad94635df5765bf48c402675241ced
SHA-1        97e9378337d7bc78e319f0e272cb756874c2f3ab
Authentihash 3d302c294c34c2c7cf26b341e0b07d9bb68160ded0c4ace0d98c298127183265
Imphash      278af6557fdb72a439b496c52749bf63
File Type    Win32 EXE
Magic        PE32 executable for MS Windows (GUI) Intel 80386 32-bit
SSDeep       3072:giBxhVyELxjBJOa9m8KgVrc0Hw+MFhmkpq8nbnNysyx:giXh8ELNBJOa91zG0HY/bJ
TRiD         Win32 Executable MS Visual C++ (generic) (41%)
             Win64 Executable (generic) (36.3%)
             Win32 Dynamic Link Library (generic) (8.6%)
             Win32 Executable (generic) (5.9%)
             OS/2 Executable (generic) (2.6%)
File Size    197 KB
```

#### PE Sections
```
Name   Virtual address  Virtual size  Raw size  Entropy  MD5
.text  4096             90678         91136     6.86     46cf40ec09f67381895f1b94acacb635
.rdata 98304            17618         17920     5.07     6ac4ac18e6b46408b2f15edc419a9dda
.data  118784           25500         22016     0.96     3c4a62453793b3bdcfb892f064477764
.mysec 147456           4100          1024      0.04     f3af3dd604471ef54e7159914f6da0ec
.rsrc  155648           61016         61440     4.98     501438180c5700c4908b5c9f0d92550c
.reloc 217088           6998          7168      0.00     21eb7229dde310fab9cd2dbec6208123
 ```
 
![PS1](https://github.com/d35ha/MalwareAnalysisReports/raw/master/dc9308fbde3d3d77cfe16b96f002a08f/Image/psstudio_sections.PNG)

#### PE Imports
```
[+] KERNEL32.DLL
    ├─── GetLastError
    ├─── TlsGetValue
    ├─── HeapFree
    ├─── TlsAlloc
    ├─── EnterCriticalSection
    ├─── GetConsoleOutputCP
    ├─── SetHandleCount
    ├─── LoadLibraryW
    ├─── GetOEMCP
    ├─── LCMapStringA
    ├─── IsDebuggerPresent
    ├─── GetTickCount
    ├─── SetProcessShutdownParameters
    ├─── SetFileApisToANSI
    ├─── GetEnvironmentStringsW
    ├─── GetModuleFileNameA
    ├─── SetConsoleOutputCP
    ├─── RtlUnwind
    ├─── LoadLibraryA
    ├─── GetStdHandle
    ├─── DeleteCriticalSection
    ├─── FlushViewOfFile
    ├─── EnumSystemLocalesA
    ├─── GetLocaleInfoA
    ├─── HeapSize
    ├─── GetCurrentProcessId
    ├─── LCMapStringW
    ├─── UnhandledExceptionFilter
    ├─── GetCommandLineW
    ├─── IsValidCodePage
    ├─── GetCPInfo
    ├─── ExitProcess
    ├─── GetCPInfoExA
    ├─── MultiByteToWideChar
    ├─── GetStartupInfoW
    ├─── FreeEnvironmentStringsW
    ├─── InitializeCriticalSectionAndSpinCount
    ├─── GetProcAddress
    ├─── GetProfileSectionA
    ├─── GetUserDefaultLCID
    ├─── AddAtomW
    ├─── GetLocaleInfoW
    ├─── GetStartupInfoA
    ├─── EnumResourceLanguagesW
    ├─── RaiseException
    ├─── WideCharToMultiByte
    ├─── GetModuleFileNameW
    ├─── TlsFree
    ├─── LeaveCriticalSection
    ├─── SetUnhandledExceptionFilter
    ├─── WriteFile
    ├─── GetCurrentProcess
    ├─── GetStringTypeA
    ├─── CloseHandle
    ├─── GetSystemTimeAsFileTime
    ├─── IsValidLocale
    ├─── GetACP
    ├─── HeapReAlloc
    ├─── GetStringTypeW
    ├─── GetModuleHandleW
    ├─── GetConsoleSelectionInfo
    ├─── HeapAlloc
    ├─── LocalFree
    ├─── TerminateProcess
    ├─── CreateProcessA
    ├─── QueryPerformanceCounter
    ├─── GetProcessShutdownParameters
    ├─── InitializeCriticalSection
    ├─── HeapCreate
    ├─── VirtualFree
    ├─── InterlockedDecrement
    ├─── Sleep
    ├─── GetFileType
    ├─── TlsSetValue
    ├─── GlobalGetAtomNameA
    ├─── GetCurrentThreadId
    ├─── InterlockedIncrement
    ├─── VirtualAlloc
    ├─── RemoveVectoredExceptionHandler
    ├─── SetLastError
    └─── SetConsoleTextAttribute

[+] GDI32.dll
    ├─── BeginPath
    └─── AddFontResourceExA

[+] MSIMG32.dll
    └─── TransparentBlt

[+] ole32.dll
    └─── IsAccelerator
```

#### VirusTotal Scan

![VT1](https://github.com/d35ha/MalwareAnalysisReports/raw/master/dc9308fbde3d3d77cfe16b96f002a08f/Image/VT1.PNG)
![VT2](https://github.com/d35ha/MalwareAnalysisReports/raw/master/dc9308fbde3d3d77cfe16b96f002a08f/Image/VT2.PNG)
![VT3](https://github.com/d35ha/MalwareAnalysisReports/raw/master/dc9308fbde3d3d77cfe16b96f002a08f/Image/VT3.PNG)

#### Malicious Indicators

![PS2](https://github.com/d35ha/MalwareAnalysisReports/raw/master/dc9308fbde3d3d77cfe16b96f002a08f/Image/psstudio_indicators.PNG)

#### Static Analysis Summary

1) The file is a x86 windows binary, with a unique section called `.mysec`</br>
2) The export-table directory is invalid</br>
a) What's export-table ?</br>
└─── According to [msdn](https://docs.microsoft.com/en-us/windows/desktop/debug/pe-format#export-directory-table), ```The export directory table contains address information that is used to resolve imports to the entry points within this image.```, So It's a table holding the addresses of different entrypoints (excluding the main entrypoint) so a malware author can execute some functions even before the main entrypoint by misusing it</br>
b) Why **Invalid export-table directory** is considered to be Malicious ?</br>
└─── Because It's a Known anti-debugging method, as an invalid export table will have invalid addresses, so at debugging time it will cause the debugger to get memory read error, for example at IDA I got this

![ida_error](https://github.com/d35ha/MalwareAnalysisReports/raw/master/dc9308fbde3d3d77cfe16b96f002a08f/Image/ida_error.PNG)

And at x32dbg I got

![x32dbg_error](https://github.com/d35ha/MalwareAnalysisReports/raw/master/dc9308fbde3d3d77cfe16b96f002a08f/Image/x32dbg_error.PNG)

3) How to bypass this ?</br>
└─── I used PEBear to remove the entire export table (setting its address and size to be zeros)</br>

![pe_bear](https://github.com/d35ha/MalwareAnalysisReports/raw/master/dc9308fbde3d3d77cfe16b96f002a08f/Image/pe_bear.PNG)

Now we can debug it without problems</br>

# Behavior Analysis

*All the Behavior analysis was done with administrative privileges*

#### Process activity

On x64 system
```
<sample> [<sample path>] [a8ad94635df5765bf48c402675241ced] [terminated]
  └─── winsvcs.exe [C:\Windows\608707440560080\winsvcs.exe] [a8ad94635df5765bf48c402675241ced]
         ├─── 2546631960.exe [C:\Users\ADMINI~1\AppData\Local\Temp\2546631960.exe] [6de4bce11266a82bd415d2a71ba6fee5] [terminated]
         ├─── 3861828847.exe [C:\Users\ADMINI~1\AppData\Local\Temp\3861828847.exe] [d5a5deeacd3f51523092967b7a011804]
         │      └─── notepad.exe [C:\Windows\notepad.exe -c C:\ProgramData\ADwXcSSGvY\cfg] [b32189bdff6e577a92baa61ad49264e6] [high cpu usage]
         └─── 3677332584.exe [C:\Users\ADMINI~1\AppData\Local\Temp\3677332584.exe] [1b601df86b36e9166650fde2ee8c1f06] [terminated]
                └─── winsvcs.exe [C:\Windows\9889597959906\winsvcs.exe] [1b601df86b36e9166650fde2ee8c1f06]
                
```

On x86 system
```
<sample> [<sample path>] [a8ad94635df5765bf48c402675241ced] [terminated]
  └─── winsvcs.exe [C:\Windows\608707440560080\winsvcs.exe] [a8ad94635df5765bf48c402675241ced]
         ├─── 2635424568.exe [C:\Users\ADMINI~1\AppData\Local\Temp\2635424568.exe] [6de4bce11266a82bd415d2a71ba6fee5] [terminated]
         ├─── 1126665688.exe [C:\Users\ADMINI~1\AppData\Local\Temp\1126665688.exe] [d5a5deeacd3f51523092967b7a011804]
         │      └─── wuapp.exe [C:\Windows\System32\wuapp.exe -c C:\ProgramData\ADwXcSSGvY\cfg] [a576c6f36a6bd456aa221599c65b3df6] [high cpu usage]
         └─── 3695548698.exe [C:\Users\ADMINI~1\AppData\Local\Temp\3695548698.exe] [1b601df86b36e9166650fde2ee8c1f06] [terminated]
                └─── winsvcs.exe [C:\Windows\9889597959906\winsvcs.exe] [1b601df86b36e9166650fde2ee8c1f06]
```

It copies itself from the current directory to `C:\Windows\608707440560080\winsvcs.exe` and then executes 3 other binaries:</br>
1) The first will be terminated after some time</br> 
2) The second is using process hollowing technique to inject some code in `notepad.exe` or `wuapp.exe` (which I think a cpu-miner) with arguments ` -c C:\ProgramData\ADwXcSSGvY\cfg`</br>
3) The third one copies itself to `C:\Windows\9889597959906\winsvcs.exe` (which I think an update for `C:\Windows\608707440560080\winsvcs.exe`)</br>

#### Interesting memory strings

I used process hacker to get memory strings from all of them</br>

From `notepad.exe` or `wuapp.exe` I could extract</br>

```
{
	"algo": "cryptonight",
	"autosave": false,
	"background": false,
	"colors": true,
	"retries": 5,
	"retry-pause": 5,
	"syslog": false,
	"print-time": 60,
	"av": 0,
	"safe": false,
	"cpu-priority": null,
	"cpu-affinity": null,
	"donate-level": 0,
	"threads": 2,
	"pools": [
		{
			"url": "92.63.197.153:9090",
			"user": "0df7607b-12b4-4015-80ea-7e6afecae666",
			"pass": "x",
			"keepalive": false,
			"nicehash": false,
			"variant": 2,
			"tls": false,
			"tls-fingerprint": null
		}
	],
	"api": {
		"port": 0,
		"access-token": null,
		"worker-id": null
	}
}
Intel(R) Core(TM) i7-6500U CPU @ 2.50GHz
C:\ProgramData\ADwXcSSGvY\cfg
[2019-01-29 13:57:33] speed 10s/60s/15m n/a n/a n/a H/s max n/a H/s
XMRig/2.8.1 (Windows NT 6.1; Win64; x64) libuv/1.23.0 gcc/8.2.0
!This program cannot be run in DOS mode.
Usage: xmrig [OPTIONS]
Options:
  -a, --algo=ALGO          specify the algorithm to use
                             cryptonight
                             cryptonight-lite
                             cryptonight-heavy
  -o, --url=URL            URL of mining server
  -O, --userpass=U:P       username:password pair for mining server
  -u, --user=USERNAME      username for mining server
  -p, --pass=PASSWORD      password for mining server
      --rig-id=ID          rig identifier for pool-side statistics (needs pool support)
  -t, --threads=N          number of miner threads
  -v, --av=N               algorithm variation, 0 auto select
  -k, --keepalive          send keepalived packet for prevent timeout (needs pool support)
      --nicehash           enable nicehash.com support
      --tls                enable SSL/TLS support (needs pool support)
      --tls-fingerprint=F  pool TLS certificate fingerprint, if set enable strict certificate pinning
  -r, --retries=N          number of times to retry before switch to backup server (default: 5)
  -R, --retry-pause=N      time to pause between retries (default: 5)
      --cpu-affinity       set process affinity to CPU core(s), mask 0x3 for cores 0 and 1
      --cpu-priority       set process priority (0 idle, 2 normal to 5 highest)
      --no-huge-pages      disable huge pages support
      --no-color           disable colored output
      --variant            algorithm PoW variant
      --donate-level=N     donate level, default 5%% (5 minutes in 100 minutes)
      --user-agent         set custom user-agent string for pool
  -B, --background         run the miner in the background
  -c, --config=FILE        load a JSON-format configuration file
  -l, --log-file=FILE      log all output to a file
      --max-cpu-usage=N    maximum CPU usage for automatic threads mode (default 75)
      --safe               safe adjust threads and av settings for current CPU
      --asm=ASM            ASM code for cn/2, possible values: auto, none, intel, ryzen.
      --print-time=N       print hashrate report every N seconds
      --api-port=N         port for the miner API
      --api-access-token=T access token for API
      --api-worker-id=ID   custom worker-id for API
      --api-id=ID          custom instance ID for API
      --api-ipv6           enable IPv6 support for API
      --api-no-restricted  enable full remote access (only if API token set)
      --dry-run            test configuration and exit
  -h, --help               display this help and exit
  -V, --version            output version information and exit
  donate.v2.xmrig.com
```

So I'm sure now, It's process hollowing injection and it injects [XMRIG](https://github.com/xmrig/xmrig) monero cpu miner</br>
And here we have the configuration data of the miner</br>
The mining pool is `92.63.197.153:9090` and the miner has a specific id which is `0df7607b-12b4-4015-80ea-7e6afecae666`</br>
The configuration file should be `C:\ProgramData\ADwXcSSGvY\cfg` (I will cover this soon)</br>

From the other processes I Found some interesting stuff like a lot of domains</br>

![mem1](https://github.com/d35ha/MalwareAnalysisReports/raw/master/dc9308fbde3d3d77cfe16b96f002a08f/Image/pr_hacker_b_a1.PNG)

When I took this snip I was writing this walkthrough, and I found what I'm writing now in the memory of the malware, so It should also be reading from clipboard for some reason !!!! </br>

![mem2](https://github.com/d35ha/MalwareAnalysisReports/raw/master/dc9308fbde3d3d77cfe16b96f002a08f/Image/pr_hacker_b_a2.PNG)

In addition to some random things like domains, urls, cmd commands, random processes names, a part of vbscript !!</br>

![mem3](https://github.com/d35ha/MalwareAnalysisReports/raw/master/dc9308fbde3d3d77cfe16b96f002a08f/Image/pr_hacker_b_a3.PNG)
![mem4](https://github.com/d35ha/MalwareAnalysisReports/raw/master/dc9308fbde3d3d77cfe16b96f002a08f/Image/pr_hacker_b_a4.PNG)
![mem5](https://github.com/d35ha/MalwareAnalysisReports/raw/master/dc9308fbde3d3d77cfe16b96f002a08f/Image/pr_hacker_b_a5.PNG)
![mem6](https://github.com/d35ha/MalwareAnalysisReports/raw/master/dc9308fbde3d3d77cfe16b96f002a08f/Image/pr_hacker_b_a6.PNG)
![mem7](https://github.com/d35ha/MalwareAnalysisReports/raw/master/dc9308fbde3d3d77cfe16b96f002a08f/Image/pr_hacker_b_a7.PNG)

#### File System Monitoring

I used Moo0 file monitor</br>

![Moo0](https://github.com/d35ha/MalwareAnalysisReports/raw/master/dc9308fbde3d3d77cfe16b96f002a08f/Image/Moo0.PNG)

In Addition to creating `winsvcs.exe` and random-name binaries at temp folder it also creates 5 files `windrvmgr32.exe`, `cfg`, `cfgi`, `r.vbs` at `C:\ProgramData\ADwXcSSGvY` and `LtHgNeMqRB.url` at the startup folder</br>
For `windrvmgr32.exe` after testing, I found that it's just the injector (must be related with the re-start mechanism)</br>
For `cfg`, `cfgi` both of them have the same content which is the configurations for the miner</br>

![cfg](https://github.com/d35ha/MalwareAnalysisReports/raw/master/dc9308fbde3d3d77cfe16b96f002a08f/Image/cfg.PNG)

For `LtHgNeMqRB.url` we have a .url file at the startup folder</br>

![url](https://github.com/d35ha/MalwareAnalysisReports/raw/master/dc9308fbde3d3d77cfe16b96f002a08f/Image/url.PNG)

It misuses the file to execute the command `C:\ProgramData\ADwXcSSGvY\windrvmgr32.exe` (as I thought before, this is for the re-start mechanism)</br>

For `r.vbs`, I dumped it</br>

```vb
Set objFSO=CreateObject("Scripting.FileSystemObject")
outFile="C:\Users\Administrator\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\LtHgNeMqRB.url"
Set objFile = objFSO.CreateTextFile(outFile,True)
objFile.Write "[InternetShortcut]" & vbCrLf & "URL=""file:///C:\ProgramData\ADwXcSSGvY\windrvmgr32.exe"""
objFile.Close
```

Now it's clear that this vbs is used to create the .url file and then removed</br>

#### registry Monitoring

For this section I used procmon from microsoft sysinternals</br>

I set the filters as below</br>

![procmon](https://github.com/d35ha/MalwareAnalysisReports/raw/master/dc9308fbde3d3d77cfe16b96f002a08f/Image/procmon.PNG)

The capture was</br>

![reg](https://github.com/d35ha/MalwareAnalysisReports/raw/master/dc9308fbde3d3d77cfe16b96f002a08f/Image/reg.PNG)

Which does this</br>
1) Creates a key at `SOFTWARE\Microsoft\windows\CurrentVersion\Run` on both `HKCU` and `HKLM` with name `Microsoft Windows Services` and value of `C:\windows\\608707440560080\winsvcs.exe`, so it can run again at the startup</br>
2) At `HKCU\Software\Microsoft\Windows\CurrentVersion\Internet Settings` it sets `ProxyEnable` to be 0, `ProxyServer` to be `127.0.0.1:8888`, so it changes the proxy settings for some reason</br>
3) Overwrite the value of `Microsoft Windows Services` with the updated binary path at `HKCU`, `HKLM`</br>

#### Network Traffic Monitoring

For this section I used Wireshark and Fiddler</br>

For fiddler we have</br>

![fiddler](https://github.com/d35ha/MalwareAnalysisReports/raw/master/dc9308fbde3d3d77cfe16b96f002a08f/Image/fiddler.PNG)

Which will download from `92.63.197.153` the files 1.exe, 3.exe, also it tries to download c.txt but 404 returned (I think ,if existed, this will be used as a config file instead of the stored one, this trick may be used by the attacker to enable him from changing the config file rapidly on all the bots)</br>

For Wireshark we have</br>

1) First file download

![ws1](https://github.com/d35ha/MalwareAnalysisReports/raw/master/dc9308fbde3d3d77cfe16b96f002a08f/Image/wireshark1.PNG)

I dumped and tested it, and it's just the update (new winsvcs.exe) and it will be renamed to a random name</br>

2) Second file download and it also tries to download 2.exe, 4.exe, 5.exe

![ws2](https://github.com/d35ha/MalwareAnalysisReports/raw/master/dc9308fbde3d3d77cfe16b96f002a08f/Image/wireshark2.PNG)
![ws3](https://github.com/d35ha/MalwareAnalysisReports/raw/master/dc9308fbde3d3d77cfe16b96f002a08f/Image/wireshark3.PNG)

I dumped and tested it, and it's just the injector and it will be renamed to a random name</br>

3) Also we have a part of the requests between the miner and the pool (stratum protocol)</br>

![ws4](https://github.com/d35ha/MalwareAnalysisReports/raw/master/dc9308fbde3d3d77cfe16b96f002a08f/Image/wireshark4.PNG)

4) And it makes a lot of dns queries about a lot of different invalid domains, I think it just does that to hide the actual domain or to mislead the analysts</br>

![ws5](https://github.com/d35ha/MalwareAnalysisReports/raw/master/dc9308fbde3d3d77cfe16b96f002a08f/Image/wireshark5.PNG)

#### Behavior Analysis Summary

1) The binary will copy itself to another location, and execute the newly-copied file</br>
2) It will download 1.exe and 3.exe from `92.63.197.153`, rename both of them with random names and execute them</br>
3) Tries to download 2.exe, 4.exe, 5.exe but fails (if downloaded, they will be also renamed and executed)</br>
4) It sets entries at the startup registry keys</br>
5) 1.exe is just the original file but updated and at running it will start to download 1.exe and 3.exe again and execute them in addition to overwriting the startup registry values set before</br>
6) 3.exe is the injector, at running it will copy itself to some directory and puts the config files at it in addition to a vbs script that will be executed to add a .url file (containing the command of the newly-copied file) to the startup folder</br>
7) 3.exe uses process hollowing to inject the whole xmrig miner inside `notepad.exe` or `wuapp.exe` and pointed the config file to it</br>

# Dynamic Analysis

Can we dig more ?</br>
Can we get more information about the techniques used here ?</br>
Yes we can and the result will be great !!!</br>

# To Be Added
